# üîß Fix: Infinite Recursion in RLS Policies

## –ü—Ä–æ–±–ª–µ–º–∞
```
Error: infinite recursion detected in policy for relation "profiles"
```

–≠—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∫–æ–≥–¥–∞ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ —Å—Å—ã–ª–∞—é—Ç—Å—è –¥—Ä—É–≥ –Ω–∞ –¥—Ä—É–≥–∞ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏:
- –ü–æ–ª–∏—Ç–∏–∫–∞ `profiles` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ-—Ç–æ –≤ `guides`
- –ü–æ–ª–∏—Ç–∏–∫–∞ `guides` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ-—Ç–æ –≤ `profiles`
- ‚Üí –ë–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è —Ä–µ–∫—É—Ä—Å–∏—è! üí•

## –†–µ—à–µ–Ω–∏–µ (3 –º–∏–Ω—É—Ç—ã)

### –®–∞–≥ 1: –û—Ç–∫—Ä–æ–π—Ç–µ Supabase SQL Editor
1. https://supabase.com/dashboard ‚Üí –≤–∞—à –ø—Ä–æ–µ–∫—Ç
2. SQL Editor (–ª–µ–≤–æ–µ –º–µ–Ω—é)

### –®–∞–≥ 2: –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç
–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –≤–µ—Å—å —Ñ–∞–π–ª:
```
supabase/FIX-RLS-INFINITE-RECURSION.sql
```

### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç?

1. **–£–¥–∞–ª—è–µ—Ç –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏** (DROP POLICY)
   - –£–±–∏—Ä–∞–µ—Ç –≤—Å–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏
   - –û—á–∏—â–∞–µ—Ç –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

2. **–°–æ–∑–¥–∞–µ—Ç –ø—Ä–æ—Å—Ç—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –±–µ–∑ —Ä–µ–∫—É—Ä—Å–∏–∏:**
   ```sql
   -- Profiles: –ü—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø –Ω–∞ —á—Ç–µ–Ω–∏–µ
   CREATE POLICY "profiles_public_read"
     ON profiles FOR SELECT
     USING (true);  -- ‚úÖ –ü—Ä–æ—Å—Ç–æ–µ –ø—Ä–∞–≤–∏–ª–æ, –±–µ–∑ —Ä–µ–∫—É—Ä—Å–∏–∏
   
   -- Guides: –ü—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø –Ω–∞ —á—Ç–µ–Ω–∏–µ
   CREATE POLICY "guides_public_read"
     ON guides FOR SELECT
     USING (true);  -- ‚úÖ –ü—Ä–æ—Å—Ç–æ–µ –ø—Ä–∞–≤–∏–ª–æ, –±–µ–∑ —Ä–µ–∫—É—Ä—Å–∏–∏
   ```

3. **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏
   - –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å —Å JOIN

## –ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?

### ‚ùå –°—Ç–∞—Ä—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏ (—Å —Ä–µ–∫—É—Ä—Å–∏–µ–π):
```sql
-- profiles –ø–æ–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç guides
CREATE POLICY ON profiles
  USING (
    EXISTS (SELECT 1 FROM guides WHERE guides.id = profiles.id)
  );

-- guides –ø–æ–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç profiles  
CREATE POLICY ON guides
  USING (
    EXISTS (SELECT 1 FROM profiles WHERE profiles.id = guides.id)
  );
-- ‚Üí –ë–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è —Ä–µ–∫—É—Ä—Å–∏—è!
```

### ‚úÖ –ù–æ–≤—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏ (–±–µ–∑ —Ä–µ–∫—É—Ä—Å–∏–∏):
```sql
-- –ü—Ä–æ—Å—Ç–æ–µ –ø—Ä–∞–≤–∏–ª–æ: –≤—Å–µ –º–æ–≥—É—Ç —á–∏—Ç–∞—Ç—å
CREATE POLICY ON profiles FOR SELECT USING (true);
CREATE POLICY ON guides FOR SELECT USING (true);
-- ‚Üí –ù–∏–∫–∞–∫–æ–π —Ä–µ–∫—É—Ä—Å–∏–∏!
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

**–í–æ–ø—Ä–æ—Å:** –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ª–∏ –¥–∞–≤–∞—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø –Ω–∞ —á—Ç–µ–Ω–∏–µ?

**–û—Ç–≤–µ—Ç:** –î–∞! ‚úÖ
- Profiles —Å–æ–¥–µ—Ä–∂–∞—Ç —Ç–æ–ª—å–∫–æ –ø—É–±–ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–∏–º—è, –∞–≤–∞—Ç–∞—Ä)
- Guides ‚Äî —ç—Ç–æ –ø—É–±–ª–∏—á–Ω—ã–µ –ª–∏—Å—Ç–∏–Ω–≥–∏, –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–∏–¥–Ω—ã –≤—Å–µ–º
- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ –µ—â–µ –∑–∞—â–∏—â–µ–Ω–æ (—Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü)
- –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —ç—Ç–∏—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö

## –ü—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞:

1. **–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≥–∏–¥–æ–≤:**
   - http://localhost:3000/guides
   - http://localhost:3000/guides/[slug]

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å** - –æ—à–∏–±–∫–∞ –¥–æ–ª–∂–Ω–∞ –∏—Å—á–µ–∑–Ω—É—Ç—å! ‚ú®

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ SQL Editor:**
   ```sql
   -- –≠—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –æ—à–∏–±–æ–∫
   SELECT 
       g.id,
       g.slug,
       p.full_name
   FROM guides g
   LEFT JOIN profiles p ON p.id = g.id
   LIMIT 5;
   ```

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –ø–æ–∑–∂–µ:

```sql
-- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ approved guides
CREATE POLICY "guides_select_approved"
  ON guides FOR SELECT
  USING (status = 'approved');

-- –ù–æ profiles –¥–æ–ª–∂–Ω—ã –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –ø—É–±–ª–∏—á–Ω—ã–º–∏!
-- –ò–Ω–∞—á–µ –≤–µ—Ä–Ω–µ—Ç—Å—è —Ä–µ–∫—É—Ä—Å–∏—è
```

## Troubleshooting

### –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –æ—Å—Ç–∞–ª–∞—Å—å:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –ø–æ–ª–∏—Ç–∏–∫–∏ —É–¥–∞–ª–µ–Ω—ã:**
   ```sql
   SELECT * FROM pg_policies WHERE tablename IN ('profiles', 'guides');
   ```

2. **–û—Ç–∫–ª—é—á–∏—Ç–µ RLS –≤—Ä–µ–º–µ–Ω–Ω–æ (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞):**
   ```sql
   ALTER TABLE profiles DISABLE ROW LEVEL SECURITY;
   ALTER TABLE guides DISABLE ROW LEVEL SECURITY;
   ```

3. **–í–∫–ª—é—á–∏—Ç–µ –æ–±—Ä–∞—Ç–Ω–æ —Å –Ω–æ–≤—ã–º–∏ –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏:**
   ```sql
   ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
   ALTER TABLE guides ENABLE ROW LEVEL SECURITY;
   -- –ü–æ—Ç–æ–º –∑–∞–ø—É—Å—Ç–∏—Ç–µ FIX-RLS-INFINITE-RECURSION.sql
   ```

---

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~1 –º–∏–Ω—É—Ç–∞  
**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** ‚úÖ –ü—É–±–ª–∏—á–Ω–æ–µ —á—Ç–µ–Ω–∏–µ, –∑–∞—â–∏—â–µ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å  
**–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å –≤–∞—à–µ–π —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
